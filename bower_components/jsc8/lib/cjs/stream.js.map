{"version":3,"file":"stream.js","sourceRoot":"","sources":["../../src/stream.ts"],"names":[],"mappings":"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","sourcesContent":["import { Connection } from \"./connection\";\nimport { getFullStreamPath } from \"./util/helper\";\nimport { btoa } from \"./util/btoa\";\nimport { stringify } from 'query-string';\n\n// 2 document\n// 3 edge\n// 4 persistent\n\nimport { ws } from \"./util/webSocket\";\n\nexport enum StreamConstants {\n  PERSISTENT = \"persistent\"\n}\n\nexport type wsCallbackObj = {\n  onopen?: () => void;\n  onclose?: () => void;\n  onerror?: (e: Error) => void;\n  onmessage: (msg: string) => Promise<boolean> | boolean | void;\n};\n\nexport class Stream {\n  private _connection: Connection;\n  name: string;\n  local: boolean;\n  isCollectionStream: boolean;\n  topic: string;\n  private _producer: any;\n  private _noopProducer: any;\n  private _consumers: any[];\n  private _setIntervalId?: any;\n  private _producerIntervalId?: any;\n\n  constructor(\n    connection: Connection,\n    name: string,\n    local: boolean = false,\n    isCollectionStream: boolean = false\n  ) {\n    this._connection = connection;\n    this.isCollectionStream = isCollectionStream;\n    this.local = local;\n    this._consumers = [];\n    this._setIntervalId = undefined;\n    this._producerIntervalId = undefined;\n    this.name = name;\n\n    let topic = this.name;\n    if (!this.isCollectionStream) {\n      if (this.local) topic = `c8locals.${this.name}`;\n      else topic = `c8globals.${this.name}`;\n    }\n    this.topic = topic;\n  }\n\n  _getPath(useName: boolean, urlSuffix?: string): string {\n    let topic = useName ? this.name : this.topic;\n    return getFullStreamPath(topic, urlSuffix);\n  }\n\n  createStream() {\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(true),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  expireMessagesOnAllSubscriptions(expireTimeInSeconds: number) {\n    const urlSuffix = `/all_subscription/expireMessages/${expireTimeInSeconds}`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  backlog() {\n    const urlSuffix = \"/backlog\";\n    return this._connection.request(\n      {\n        method: \"GET\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  getStreamStatistics() {\n    const urlSuffix = \"/stats\";\n    return this._connection.request(\n      {\n        method: \"GET\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  deleteSubscription(subscription: string) {\n    const urlSuffix = `/subscription/${subscription}`;\n    return this._connection.request(\n      {\n        method: \"DELETE\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  resetSubscriptionToPosition(subscription: string) {\n    const urlSuffix = `/subscription/${subscription}`;\n    return this._connection.request(\n      {\n        method: \"PUT\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  expireMessages(subscription: string, expireTimeInSeconds: number) {\n    const urlSuffix = `/subscription/${subscription}/expireMessages/${expireTimeInSeconds}`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  resetCursor(subscription: string) {\n    const urlSuffix = `/subscription/${subscription}/resetcursor`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  resetSubscriptionToTimestamp(subscription: string, timestamp: number) {\n    const urlSuffix = `/subscription/${subscription}/resetcursor/${timestamp}`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  skipNumberOfMessages(subscription: string, numMessages: number) {\n    const urlSuffix = `/subscription/${subscription}/skip/${numMessages}`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  skipAllMessages(subscription: string) {\n    const urlSuffix = `/subscription/${subscription}/skip_all`;\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  getSubscriptionList() {\n    const urlSuffix = \"/subscriptions\";\n    return this._connection.request(\n      {\n        method: \"GET\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  terminateStream() {\n    const urlSuffix = \"/terminate\";\n    return this._connection.request(\n      {\n        method: \"POST\",\n        path: this._getPath(false, urlSuffix),\n        qs: `local=${this.local}`\n      },\n      res => res.body\n    );\n  }\n\n  consumer(\n    subscriptionName: string,\n    callbackObj: wsCallbackObj,\n    dcName: string,\n    params: { [key: string]: any } = {}\n  ) {\n    const lowerCaseUrl = dcName.toLocaleLowerCase();\n    if (lowerCaseUrl.includes(\"http\") || lowerCaseUrl.includes(\"https\"))\n      throw \"Invalid DC name\";\n    const { onopen, onclose, onerror, onmessage } = callbackObj;\n    const persist = StreamConstants.PERSISTENT;\n    const region = this.local ? \"c8local\" : \"c8global\";\n    const tenant = this._connection.getTenantName();\n    let dbName = this._connection.getFabricName();\n    let queryParams = stringify(params)\n    if (!dbName || !tenant)\n      throw \"Set correct DB and/or tenant name before using.\";\n\n    const consumerUrl = `wss://${dcName}/_ws/ws/v2/consumer/${persist}/${tenant}/${region}.${dbName}/${\n      this.topic\n      }/${subscriptionName}?${queryParams}`;\n\n    this._consumers.push(ws(consumerUrl));\n    const lastIndex = this._consumers.length - 1;\n\n    const consumer = this._consumers[lastIndex];\n\n    consumer.on(\"open\", () => {\n      typeof onopen === \"function\" && onopen();\n    });\n\n    consumer.on(\"close\", () => {\n      this._setIntervalId && clearInterval(this._setIntervalId);\n      typeof onclose === \"function\" && onclose();\n    });\n\n    consumer.on(\"error\", (e: Error) => {\n      typeof onerror === \"function\" && onerror(e);\n    });\n\n    consumer.on(\"message\", async (msg: string) => {\n      const message = JSON.parse(msg);\n      const ackMsg = { messageId: message.messageId };\n      const { payload } = message;\n\n      if (payload !== btoa(\"noop\") && payload !== \"noop\") {\n        if (typeof onmessage === \"function\") {\n          const shouldAck = await onmessage(msg);\n          if (shouldAck !== false) {\n            consumer.send(JSON.stringify(ackMsg));\n          }\n        }\n      } else {\n        consumer.send(JSON.stringify(ackMsg));\n      }\n\n    });\n\n    !this._noopProducer && this.noopProducer(dcName);\n\n    return consumer;\n  }\n\n  private noopProducer(dcName: string) {\n    const lowerCaseUrl = dcName.toLocaleLowerCase();\n    if (lowerCaseUrl.includes(\"http\") || lowerCaseUrl.includes(\"https\"))\n      throw \"Invalid DC name\";\n    const persist = StreamConstants.PERSISTENT;\n    const region = this.local ? \"c8local\" : \"c8global\";\n    const tenant = this._connection.getTenantName();\n    let dbName = this._connection.getFabricName();\n    if (!dbName || !tenant)\n      throw \"Set correct DB and/or tenant name before using.\";\n\n    const noopProducerUrl = `wss://${dcName}/_ws/ws/v2/producer/${persist}/${tenant}/${region}.${dbName}/${\n      this.topic\n      }`;\n\n    this._noopProducer = ws(noopProducerUrl);\n\n    this._noopProducer.on(\"open\", () => {\n      this._setIntervalId = setInterval(() => {\n        this._noopProducer.send(JSON.stringify({ payload: \"noop\" }));\n      }, 30000);\n    });\n\n    this._noopProducer.on(\"error\", (e: Event) =>\n      console.log(\"noop producer errored \", e)\n    );\n  }\n\n  producer(\n    message: string | Array<string>,\n    dcName?: string,\n    callbackObj?: wsCallbackObj\n  ) {\n    type CallbackFunction = () => void;\n    let onopen: CallbackFunction | undefined;\n    let onclose: CallbackFunction | undefined;\n    let onmessage: (msg: string) => Promise<boolean> | boolean | void;\n    let onerror: ((e: Error) => void) | undefined;\n    if (callbackObj !== undefined) {\n      onopen = callbackObj.onopen;\n      onclose = callbackObj.onclose;\n      onmessage = callbackObj.onmessage;\n      onerror = callbackObj.onerror;\n    }\n    if (this._producer === undefined) {\n      if (!dcName)\n        throw \"DC name not provided to establish producer connection\";\n\n      const lowerCaseUrl = dcName.toLocaleLowerCase();\n      if (lowerCaseUrl.includes(\"http\") || lowerCaseUrl.includes(\"https\"))\n        throw \"Invalid DC name\";\n      const persist = StreamConstants.PERSISTENT;\n      const region = this.local ? \"c8local\" : \"c8global\";\n      const tenant = this._connection.getTenantName();\n      let dbName = this._connection.getFabricName();\n      if (!dbName || !tenant)\n        throw \"Set correct DB and/or tenant name before using.\";\n\n      const producerUrl = `wss://${dcName}/_ws/ws/v2/producer/${persist}/${tenant}/${region}.${dbName}/${\n        this.topic\n        }`;\n\n      this._producer = ws(producerUrl);\n\n      this._producer.on(\"message\", (msg: string) => {\n        typeof onmessage === \"function\" && onmessage(msg);\n      });\n\n      this._producer.on(\"open\", () => {\n        this._producerIntervalId = setInterval(() => {\n          this._producer.send(JSON.stringify({ payload: \"noop\" }));\n        }, 30000);\n        if (!Array.isArray(message)) {\n          this._producer.send(JSON.stringify({ payload: btoa(message) }));\n        } else {\n          for (let i = 0; i < message.length; i++) {\n            this._producer.send(JSON.stringify({ payload: btoa(message[i]) }));\n          }\n        }\n        typeof onopen === \"function\" && onopen();\n      });\n      this._producer.on(\"close\", () => {\n        clearInterval(this._producerIntervalId);\n        typeof onclose === \"function\" && onclose();\n      });\n\n      this._producer.on(\"error\", (e: Error) => {\n        typeof onerror === \"function\" && onerror(e);\n      });\n    } else {\n      if (this._producer.readyState === this._producer.OPEN) {\n        if (!Array.isArray(message)) {\n          this._producer.send(JSON.stringify({ payload: btoa(message) }));\n        } else {\n          for (let i = 0; i < message.length; i++) {\n            this._producer.send(JSON.stringify({ payload: btoa(message[i]) }));\n          }\n        }\n      } else {\n        console.warn(\"Producer connection not open yet. Please wait.\");\n      }\n    }\n  }\n\n  closeConnections() {\n    this._setIntervalId && clearInterval(this._setIntervalId);\n    this._producerIntervalId && clearInterval(this._producerIntervalId);\n    this._producer && this._producer.terminate();\n    this._noopProducer && this._noopProducer.terminate();\n    this._consumers &&\n      this._consumers.forEach(consumer => consumer.terminate());\n  }\n}\n"]}